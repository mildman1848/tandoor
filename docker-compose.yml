---
services:
  tandoor:
    image: ${IMAGE_NAME:-mildman1848/tandoor}:${IMAGE_TAG:-latest}
    container_name: tandoor
    hostname: tandoor
    restart: unless-stopped

    # Security hardening (basic)
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
      - SETGID
      - SETUID

    # Network configuration
    ports:
      - "${HOST:-127.0.0.1}:${EXTERNAL_PORT:-8080}:8080"

    # Environment configuration
    environment:
      # LinuxServer.io base variables
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-Etc/UTC}
      - UMASK=${UMASK:-022}

      # Django configuration
      - DEBUG=${DEBUG:-False}
      - DJANGO_SETTINGS_MODULE=${DJANGO_SETTINGS_MODULE:-recipes.settings}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS:-*}

      # Database configuration (SQLite3 as default)
      - DB_ENGINE=${DB_ENGINE:-django.db.backends.sqlite3}
      - DATABASE_URL=${DATABASE_URL:-sqlite:////config/db.sqlite3}

      # Media and static files
      - STATIC_ROOT=${STATIC_ROOT:-/app/staticfiles}
      - MEDIA_ROOT=${MEDIA_ROOT:-/app/mediafiles}

      # Gunicorn configuration
      - GUNICORN_WORKERS=${GUNICORN_WORKERS:-2}
      - GUNICORN_TIMEOUT=${GUNICORN_TIMEOUT:-120}

      # Optional: FILE__ prefix secrets support
      - FILE__SECRET_KEY=/run/secrets/tandoor_secret_key

    # Volume mounts
    volumes:
      - ${CONFIG_PATH:-./config}:/config
      - ${MEDIAFILES_PATH:-./data/mediafiles}:/app/mediafiles
      - ${STATICFILES_PATH:-./data/staticfiles}:/app/staticfiles
      - ${LOGS_PATH:-./logs}:/config/logs

    # Optional: Docker secrets support
    secrets:
      - tandoor_secret_key

    # Health check (process-based for security)
    healthcheck:
      test: ["CMD", "sh", "-c", "ps aux | grep -v grep | grep python || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Labels for better organization
    labels:
      - "org.opencontainers.image.title=tandoor"
      - "org.opencontainers.image.description=Tandoor Recipes - Recipe management server with S6 Overlay"
      - "org.opencontainers.image.vendor=Mildman1848"

# Docker secrets (optional)
secrets:
  tandoor_secret_key:
    file: ${SECRETS_PATH:-./secrets}/tandoor_secret_key.txt

# Networks (optional)
networks:
  default:
    name: ${NETWORK_NAME:-tandoor_network}
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: ${NETWORK_SUBNET:-172.18.0.0/16}